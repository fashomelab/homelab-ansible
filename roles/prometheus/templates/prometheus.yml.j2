global:
    scrape_interval: 15s
    evaluation_interval: 15s

scrape_configs:
    - job_name: 'node-exporter'
      static_configs:
        - targets:
            {% for host in groups['node_exporter_targets'] %}
            - "{{ hostvars[host].ansible_host | default(hostvars[host].ansible_default_ipv4.address) }}:9100"
            {% endfor %}

    - job_name: 'kubehn-prometheus-federation'
      metrics_path: /federate
      params:
        'match[]':
          - '{job="node-exporter"}'
          - '{job="kube-state-metrics"}'
          - '{job="kubernetes-nodes"}'
      static_configs:
        - targets:
            - "{{ kubehn_prometheus_endpoint | default('prometheus_external_service_ip:9090') }}"
      relabel_configs:
        - source_labels: [__address__]
          target_label: cluster
          replacement: 'kubehn'

    - job_name: 'kubezd-prometheus-federation'
      metrics_path: /federate
      params:
        'match[]':
          - '{job="node-exporter"}'
          - '{job="kube-state-metrics"}'
          - '{job="kubernetes-nodes"}'
      static_configs:
        - targets:
            - "{{ kubezd_prometheus_endpoint | default('prometheus_external_service_ip:9090') }}"
      relabel_configs:
        - source_labels: [__address__]
          target_label: cluster
          replacement: 'kubezd'